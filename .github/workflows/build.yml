name: Build Windows and macOS App

on:
  push:
    branches: [main]
  pull_request:

env:
  FLUTTER_VERSION: 3.38.5
  PYTHON_VERSION: '3.13'

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Flutter pub get
        run: flutter pub get

      # macOS
      - name: Build macOS App
        if: matrix.os == 'macos-latest'
        run: |
          python build.py --build macos
          hdiutil create -format UDZO \
            -srcfolder build/macos/Build/Products/Release/XJI\ Media\ Toolbox.app \
            build/macos/Build/Products/Release/xji_media_toolbox_macos.dmg

      # Windows
      - name: Build Windows App
        if: matrix.os == 'windows-latest'
        run: flutter build windows --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xji_media_toolbox_${{ matrix.os }}
          path: |
            build/macos/Build/Products/Release/*.dmg
            build/windows/x64/runner/Release/*